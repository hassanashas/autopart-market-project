with invoice_hdr as (
    select
        i.invoice_id,
        i.invoice_da,
        i.invtype,
        i.instanceid
    from pinnacle_interim_database.invoices i
    where i.invoice_da >= current_date - 90
),

part_lines as (
    select
        d.invoice_id,
        d.icnumber as ic,
        d.icver as icver,
        d.part,
        d.price,
        d.instanceid
    from pinnacle_interim_database.invoicedetail d
    where d.inventory_id is not null
      and d.detatiltype in ('INVENTORY_ITEM', 'BROKERED_ITEM', 'EXTRA_SALE')
),

gross_sales_90 as (
    select
        ih.instanceid,
        pl.ic,
        pl.icver,
        pl.part,
        count(*) as units_sold,
        sum(pl.price) as gross_sales,
        round(avg(pl.price))::integer as avg_gross_sale_price
    from invoice_hdr ih
    join part_lines pl
      on pl.invoice_id = ih.invoice_id
     and pl.instanceid = ih.instanceid
    where ih.invtype = 'W'
      and pl.price is not null
    group by
        ih.instanceid,
        pl.ic,
        pl.icver,
        pl.part
)

select
    gs.instanceid,
    gs.ic,
    gs.icver,
    gs.part,
    gs.units_sold,
    gs.gross_sales,
    gs.avg_gross_sale_price,

    tq.current_qoh,
    tq.target_qoh,
    tq.stock_ratio,
    tq.stock_status,

    ic.model as model_code,
    m.manuname as manufacturer,
    m.name as model_name,
    ic.startyear,
    ic.endyear,
    ic.description as ic_description

from gross_sales_90 gs

join pinnacle_interim_database.target_qoh tq
  on tq.instanceid = gs.instanceid
 and tq.ic = gs.ic
 and tq.part = gs.part

left join pinnacle_interim_database.ic ic
  on ic.ic = gs.ic
 and ic.part = gs.part
 and ic.instanceid = gs.instanceid

left join pinnacle_interim_database.models m
  on m.code = ic.model
 and m.instanceid = ic.instanceid

where gs.part in ('AA', 'BA')
  and tq.stock_status in ('Out of Stock', 'Understocked')
